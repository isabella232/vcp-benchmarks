- name: "Clear cache"
  hosts: vcpbench-varnish*
  tasks:
    - name: "Force restart of varnish"
      service: name="varnish" state="restarted" enabled="yes"
- name: "Run Benchmarks"
  hosts: vcpbench-consumer
  tasks:
    - name: "Run wrk reference test (one hit url only for 10 seconds)"
      shell: /usr/local/bin/wrk -t 4 -d 10 -c 400 "http://`cat /tmp/hosts/loadbalancer.cname`/reference/?content-length&max-age=6000&header-delay=100predictable-content=202502"
      register: testresult
    - debug: var=testresult.stdout_lines
    - name: "Run wrk varnish cache plus test (4 minutes)"
      shell: /usr/local/bin/wrk -s /tmp/multipath.lua -t 4 -d 240 -c 400 "http://`cat /tmp/hosts/loadbalancer.cname`/"
      register: testresult
    - debug: var=testresult.stdout_lines
